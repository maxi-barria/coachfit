generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String    @id @default(uuid())
  email            String    @unique
  password         String
  rol              String
  resetToken       String?
  resetTokenExpiry DateTime?
  createdAt        DateTime  @default(now())

  exercises       Exercise[]
  musclePortions  MusclePortion[]
  routines        Routine[]
  workouts        Workout[]
  workoutSessions WorkoutSession[]

  // Relaciones Coach - Client
  coachClients  CoachClient[] @relation("Coach")
  clientCoaches CoachClient[] @relation("Client")

  // Relaciones con invitaciones
  coachInvitations CoachInvitation[]

  // Notas
  notesAsUser  Note[] @relation("NoteUser")
  notesAsCoach Note[] @relation("NoteCoach")
}

/**
 * ---------- Catálogos y core ----------
 */

model Muscle {
  id       String          @id @default(uuid())
  name     String
  portions MusclePortion[]
}

model MusclePortion {
  id       String  @id @default(uuid())
  name     String
  muscleId String
  userId   String?
  isCustom Boolean @default(false)

  muscle                 Muscle                  @relation(fields: [muscleId], references: [id])
  user                   User?                   @relation(fields: [userId], references: [id])
  exerciseMusclePortions ExerciseMusclePortion[]
}

model Exercise {
  id              String  @id @default(uuid())
  name            String
  description     String?
  type            String?
  secondsDuration Int?

  userId     String?
  isCustom   Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  difficulty String?
  equipment  String?
  videoUrl   String?
  thumbnail  String?

  user                   User?                   @relation(fields: [userId], references: [id])
  exerciseMusclePortions ExerciseMusclePortion[]
  workoutExercises       WorkoutExercise[]
  setSessions            SetSession[]
}

model ExerciseMusclePortion {
  id                  String @id @default(uuid())
  exerciseId          String
  musclePortionId     String
  estimatedPercentage Int

  exercise      Exercise      @relation(fields: [exerciseId], references: [id])
  musclePortion MusclePortion @relation(fields: [musclePortionId], references: [id])

  @@unique([exerciseId, musclePortionId])
}

model Routine {
  id        String   @id @default(uuid())
  userId    String
  name      String
  goal      String
  startDate DateTime
  endDate   DateTime
  editable  Boolean  @default(true)
  version   Int
  createdAt DateTime @default(now())

  user            User             @relation(fields: [userId], references: [id])
  routineWorkouts RoutineWorkout[]
}

model RoutineWorkout {
  id        String @id @default(uuid())
  routineId String
  workoutId String
  orden     Int

  routine Routine @relation(fields: [routineId], references: [id])
  workout Workout @relation(fields: [workoutId], references: [id])

  @@unique([routineId, workoutId])
}

model Workout {
  id              String   @id @default(uuid())
  userId          String
  name            String
  date            DateTime
  note            String?
  secondsDuration Int?

  user             User              @relation(fields: [userId], references: [id])
  workoutExercises WorkoutExercise[]
  routineWorkouts  RoutineWorkout[]
  workoutSessions  WorkoutSession[]
}

model WorkoutExercise {
  id         String @id @default(uuid())
  workoutId  String
  exerciseId String
  orden      Int

  workout     Workout      @relation(fields: [workoutId], references: [id])
  exercise    Exercise     @relation(fields: [exerciseId], references: [id])
  sets        Set[]
  setSessions SetSession[]
}

model Set {
  id                   String   @id @default(uuid())
  workoutExerciseId    String
  repetition           Int
  weight               Float
  intensityIndicatorId String?
  restSeconds          Int
  createdAt            DateTime @default(now())

  workoutExercise    WorkoutExercise     @relation(fields: [workoutExerciseId], references: [id])
  intensityIndicator IntensityIndicator? @relation(fields: [intensityIndicatorId], references: [id])
}

/**
 * ---------- Progreso del usuario ----------
 */

model WorkoutSession {
  id              String    @id @default(uuid())
  userId          String
  workoutId       String
  startedAt       DateTime  @default(now())
  endedAt         DateTime?
  secondsDuration Int?
  comment         String?

  user        User                   @relation(fields: [userId], references: [id])
  workout     Workout                @relation(fields: [workoutId], references: [id])
  setSessions SetSession[]
  summary     WorkoutSessionSummary?
}

model SetSession {
  id                   String   @id @default(uuid())
  workoutSessionId     String
  workoutExerciseId    String
  rep                  Int
  weight               Float
  restSeconds          Int
  intensityIndicatorId String?
  createdAt            DateTime @default(now())
  exerciseId           String?

  workoutSession     WorkoutSession      @relation(fields: [workoutSessionId], references: [id])
  workoutExercise    WorkoutExercise     @relation(fields: [workoutExerciseId], references: [id])
  intensityIndicator IntensityIndicator? @relation(fields: [intensityIndicatorId], references: [id])
  Exercise           Exercise?           @relation(fields: [exerciseId], references: [id])
}

model WorkoutSessionSummary {
  id               String   @id @default(uuid())
  workoutSessionId String   @unique
  totalVolume      Float
  totalSets        Int
  totalReps        Int
  createdAt        DateTime @default(now())

  workoutSession WorkoutSession @relation(fields: [workoutSessionId], references: [id])
}

/**
 * ---------- Catálogo de intensidad ----------
 */

model IntensityIndicator {
  id          String       @id @default(uuid())
  name        String
  value       String
  description String?
  sets        Set[]
  setSessions SetSession[]
}

/**
 * ---------- Funcionalidad Coach ----------
 */

model CoachClient {
  id        String    @id @default(uuid())
  coachId   String
  clientId  String
  note      String?
  startDate DateTime
  endDate   DateTime?

  coach  User @relation("Coach", fields: [coachId], references: [id])
  client User @relation("Client", fields: [clientId], references: [id])

  @@unique([coachId, clientId])
}

model CoachInvitation {
  id             String   @id @default(uuid())
  coachId        String
  emailClient    String
  token          String   @unique
  stateId        String
  createDate     DateTime @default(now())
  expirationDate DateTime

  coach User  @relation(fields: [coachId], references: [id])
  state State @relation(fields: [stateId], references: [id])
}

model Note {
  id      String   @id @default(uuid())
  userId  String
  coachId String
  content String
  date    DateTime @default(now())

  user  User @relation("NoteUser", fields: [userId], references: [id])
  coach User @relation("NoteCoach", fields: [coachId], references: [id])
}

model State {
  id    String @id @default(uuid())
  value String

  invitations CoachInvitation[]
}
